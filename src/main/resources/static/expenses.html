<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Pawdcast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add SheetJS library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --light-yellow-beige: #E8DCC8;
            --medium-yellow-beige: #D4C5A9;
            --dark-yellow-beige: #B8A082;
            --dark-drab-brown: #8B7355;
            --very-dark-mocha: #4A3728;
            --black-brown: #2B1F17;
            --dark-wedgwood: #4A6741;
            --white: #FFFFFF;
            --card-shadow: rgba(43, 31, 23, 0.1);
            --hover-shadow: rgba(74, 103, 65, 0.2);
            --light-wedgwood: #E8F0E6;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--very-dark-mocha);
        }
        
        .navbar {
            background: var(--dark-drab-brown) !important;
            border-bottom: 2px solid var(--medium-yellow-beige);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--white);
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin-right: 15px;
            position: relative;
        }
        
        .logo {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.4s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 3px solid var(--medium-yellow-beige);
        }
        
        .logo:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 4px 16px rgba(74, 103, 65, 0.3);
            border-color: var(--dark-wedgwood);
        }
        
        .brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .brand-main {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .brand-sub {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--light-yellow-beige);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--card-shadow);
            border: 1px solid var(--medium-yellow-beige);
            margin-bottom: 20px;
            background-color: var(--white);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 6px 12px var(--hover-shadow);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--medium-yellow-beige), var(--dark-yellow-beige));
            border-bottom: 1px solid var(--dark-yellow-beige);
            font-weight: 600;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
            color: var(--very-dark-mocha);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--dark-wedgwood), #3a5231);
            border-color: var(--dark-wedgwood);
            color: var(--white);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #3a5231, var(--dark-wedgwood));
            border-color: #3a5231;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 103, 65, 0.3);
        }
        
        .btn-outline-primary {
            border-color: var(--dark-wedgwood);
            color: var(--dark-wedgwood);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--dark-wedgwood);
            color: var(--white);
        }
        
        .expense-item {
            border-left: 4px solid var(--dark-wedgwood);
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--hover-shadow);
        }
        
        .category-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 20px;
            background-color: var(--dark-wedgwood);
            color: var(--white);
        }
        
        .amount-positive {
            color: var(--dark-drab-brown);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--medium-yellow-beige), var(--dark-yellow-beige));
            color: var(--very-dark-mocha);
            border: none;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px var(--hover-shadow);
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--black-brown);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: var(--very-dark-mocha);
            font-weight: 600;
        }
        
        .filter-section {
            background-color: var(--white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--dark-drab-brown);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--medium-yellow-beige);
        }
        
        .action-buttons .btn {
            margin-right: 5px;
        }
        
        .payment-method-badge {
            background-color: var(--medium-yellow-beige);
            color: var(--very-dark-mocha);
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .form-control, .form-select {
            border: 1px solid var(--medium-yellow-beige);
            color: var(--very-dark-mocha);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--dark-wedgwood);
            box-shadow: 0 0 0 0.2rem rgba(74, 103, 65, 0.25);
        }
        
        .rupee-symbol::before {
            content: "â‚¹";
        }
        
        .alert-position {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        /* Profile Photo Styles */
        #profilePhotoContainer {
            display: flex;
            align-items: center;
        }

        #profilePhoto {
            border: 2px solid var(--medium-yellow-beige);
        }

        .dropdown-toggle::after {
            margin-left: 0.5em;
        }

        /* Ensure dropdown aligns properly with photo */
        .dropdown-menu {
            min-width: 200px;
        }
        
        /* Footer Styles */
        .footer {
            background-color: var(--very-dark-mocha);
            color: var(--white);
            padding: 20px 0;
            margin-top: 40px;
            border-top: 3px solid var(--medium-yellow-beige);
        }
        
        .footer-logo {
            height: 30px;
            margin-right: 10px;
        }
        
        .footer a {
            color: var(--medium-yellow-beige);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer a:hover {
            color: var(--white);
        }
        
        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--light-wedgwood) 0%, var(--white) 100%);
            padding: 20px 0;
            border-bottom: 1px solid var(--medium-yellow-beige);
            margin-bottom: 30px;
        }
        
        .welcome-text {
            color: var(--dark-wedgwood);
            font-weight: 600;
        }
        
        /* Animation for cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        /* Report Section Styles */
        .report-section {
            background: linear-gradient(135deg, var(--light-wedgwood) 0%, var(--white) 100%);
            padding: 30px 0;
            border-bottom: 1px solid var(--medium-yellow-beige);
        }
        
        .report-card {
            border-left: 5px solid var(--dark-wedgwood);
            transition: all 0.3s ease;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px var(--hover-shadow);
        }
        
        .report-icon {
            font-size: 2.5rem;
            color: var(--dark-wedgwood);
            margin-bottom: 15px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .brand-main {
                font-size: 1rem;
            }
            
            .brand-sub {
                font-size: 0.7rem;
            }
            
            .logo {
                height: 50px;
                width: 50px;
            }
            
            .stats-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <div class="logo-container">
                    <img src="https://res.cloudinary.com/dkuuvasoe/image/upload/v1760186124/pawdcastlogo_cb1l1b.png" alt="Pawdcast Logo" class="logo">
                </div>
                <div class="brand-text">
                    <span class="brand-main">Pawdcast Expense Tracker</span>
                    <span class="brand-sub">Track. Save. Prosper.</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="dashboardLink"><i class="fas fa-home me-1"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="reportsLink"><i class="fas fa-chart-bar me-1"></i> Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-cog me-1"></i></a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <!-- Profile Photo Display -->
                            <div class="me-2" id="profilePhotoContainer">
                                <img id="profilePhoto" src="" alt="Profile" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover; display: none;">
                                <i id="defaultProfileIcon" class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                            </div>
                            <span id="userFullName">Loading...</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboardSection">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="welcome-text">Welcome back, <span id="userFirstName">User</span>!</h2>
                        <p class="mb-0">Track your expenses and manage your budget effectively.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span id="currentDate" class="text-muted"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card fade-in-up" style="animation-delay: 0.1s;">
                        <div class="stats-label">Total This Month</div>
                        <div class="stats-value amount-positive rupee-symbol" id="totalThisMonth">0.00</div>
                        <div class="stats-label">All Expenses</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card fade-in-up" style="animation-delay: 0.2s;">
                        <div class="stats-label">Daily Average</div>
                        <div class="stats-value rupee-symbol" id="dailyAverage">0.00</div>
                        <div class="stats-label">This Month</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card fade-in-up" style="animation-delay: 0.3s;">
                        <div class="stats-label">Largest Expense</div>
                        <div class="stats-value amount-positive rupee-symbol" id="largestExpense">0.00</div>
                        <div class="stats-label">This Month</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card fade-in-up" style="animation-delay: 0.4s;">
                        <div class="stats-label">Expense Count</div>
                        <div class="stats-value" id="expenseCount">0</div>
                        <div class="stats-label">This Month</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Left Column: Add Expense Form and Filters -->
                <div class="col-lg-4">
                    <!-- Add Expense Form -->
                    <div class="card fade-in-up" style="animation-delay: 0.5s;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Add New Expense</span>
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="card-body">
                            <form id="expenseForm">
                                <div class="mb-3">
                                    <label for="expenseDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="expenseDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <input type="text" class="form-control" id="description" placeholder="What did you spend on?" required>
                                </div>
                                <div class="mb-3">
                                    <label for="amount" class="form-label">Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text rupee-symbol"></span>
                                        <input type="number" class="form-control" id="amount" step="0.01" min="0.01" placeholder="0.00" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <select class="form-select" id="category" required>
                                        <option value="">Select a category</option>
                                        <option value="Food & Dining">Food & Dining</option>
                                        <option value="Shopping">Shopping</option>
                                        <option value="Transportation">Transportation</option>
                                        <option value="Bills & Utilities">Bills & Utilities</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Education">Education</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label">Payment Method</label>
                                    <select class="form-select" id="paymentMethod" required>
                                        <option value="Cash">Cash</option>
                                        <option value="Credit Card">Credit Card</option>
                                        <option value="Debit Card">Debit Card</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Digital Wallet">Digital Wallet</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary" id="submitExpenseBtn">
                                        <i class="fas fa-save me-2"></i> Add Expense
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card fade-in-up" style="animation-delay: 0.6s;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Filters</span>
                            <i class="fas fa-filter"></i>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="dateRange" class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="startDate">
                                    <span class="input-group-text">to</span>
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="filterCategory" class="form-label">Category</label>
                                <select class="form-select" id="filterCategory">
                                    <option value="">All Categories</option>
                                    <option value="Food & Dining">Food & Dining</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Transportation">Transportation</option>
                                    <option value="Bills & Utilities">Bills & Utilities</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Travel">Travel</option>
                                    <option value="Education">Education</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="filterPaymentMethod" class="form-label">Payment Method</label>
                                <select class="form-select" id="filterPaymentMethod">
                                    <option value="">All Methods</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Credit Card">Credit Card</option>
                                    <option value="Debit Card">Debit Card</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Digital Wallet">Digital Wallet</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" id="applyFilters">
                                    <i class="fas fa-check me-2"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" id="resetFilters">
                                    <i class="fas fa-redo me-2"></i> Reset Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Expenses List and Charts -->
                <div class="col-lg-8">
                    <!-- Expenses List -->
                    <div class="card fade-in-up" style="animation-delay: 0.7s;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Recent Expenses</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" id="refreshExpenses">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="debugSession">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="expensesList">
                                <div class="empty-state">
                                    <i class="fas fa-receipt"></i>
                                    <h5>No expenses yet</h5>
                                    <p>Add your first expense to get started</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card fade-in-up" style="animation-delay: 0.8s;">
                                <div class="card-header">
                                    Expenses by Category
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card fade-in-up" style="animation-delay: 0.9s;">
                                <div class="card-header">
                                    Monthly Trend
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthlyTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Section -->
    <div id="reportsSection" style="display: none;">
        <div class="report-section">
            <div class="container">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="welcome-text">Expense Reports</h2>
                        <p class="mb-0">Generate detailed reports of your expenses in Excel format.</p>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Report Options -->
                    <div class="col-md-4 mb-4">
                        <div class="card report-card h-100">
                            <div class="card-body text-center">
                                <div class="report-icon">
                                    <i class="fas fa-file-excel"></i>
                                </div>
                                <h5 class="card-title">Current Month Report</h5>
                                <p class="card-text">Generate a report of all expenses for the current month.</p>
                                <button class="btn btn-primary" id="generateCurrentMonthReport">
                                    <i class="fas fa-download me-2"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card report-card h-100">
                            <div class="card-body text-center">
                                <div class="report-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <h5 class="card-title">Custom Date Range</h5>
                                <p class="card-text">Generate a report for a specific date range.</p>
                                <div class="mb-3">
                                    <label for="reportStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="reportStartDate">
                                </div>
                                <div class="mb-3">
                                    <label for="reportEndDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="reportEndDate">
                                </div>
                                <button class="btn btn-primary" id="generateCustomReport">
                                    <i class="fas fa-download me-2"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card report-card h-100">
                            <div class="card-body text-center">
                                <div class="report-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h5 class="card-title">Category Summary</h5>
                                <p class="card-text">Generate a summary report grouped by expense categories.</p>
                                <div class="mb-3">
                                    <label for="categoryReportMonth" class="form-label">Select Month</label>
                                    <input type="month" class="form-control" id="categoryReportMonth">
                                </div>
                                <button class="btn btn-primary" id="generateCategoryReport">
                                    <i class="fas fa-download me-2"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Preview Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Report Preview</span>
                                <button class="btn btn-sm btn-outline-primary" id="refreshReportPreview">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="reportPreview">
                                    <div class="empty-state">
                                        <i class="fas fa-file-excel"></i>
                                        <h5>No report generated yet</h5>
                                        <p>Select a report option above to generate your first report</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <img src="https://res.cloudinary.com/dkuuvasoe/image/upload/v1760186124/pawdcastlogo_cb1l1b.png" alt="Pawdcast Logo" class="footer-logo">
                        <h5 class="mb-0">Pawdcast Expense Tracker</h5>
                    </div>
                    <p class="mb-0">Track your expenses, manage your budget, and achieve financial goals.</p>
                </div>
                <div class="col-md-3">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" id="footerDashboardLink"><i class="fas fa-home me-1"></i> Dashboard</a></li>
                        <li><a href="#" id="footerReportsLink"><i class="fas fa-chart-bar me-1"></i> Reports</a></li>
                       
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Support</h5>
                    <ul class="list-unstyled">
                        <li><a href="#"><i class="fas fa-question-circle me-1"></i> Help Center</a></li>
                        <li><a href="#"><i class="fas fa-envelope me-1"></i> Contact Us</a></li>
                        <li><a href="#"><i class="fas fa-shield-alt me-1"></i> Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <hr class="my-4" style="border-color: var(--medium-yellow-beige);">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2025 Pawdcast. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="#" class="me-3"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="me-3"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="me-3"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Edit Expense Modal -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editExpenseForm">
                        <input type="hidden" id="editExpenseId">
                        <div class="mb-3">
                            <label for="editExpenseDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="editExpenseDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="editDescription" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text rupee-symbol"></span>
                                <input type="number" class="form-control" id="editAmount" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editCategory" class="form-label">Category</label>
                            <select class="form-select" id="editCategory" required>
                                <option value="Food & Dining">Food & Dining</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Bills & Utilities">Bills & Utilities</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Travel">Travel</option>
                               
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editPaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="editPaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Debit Card">Debit Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Digital Wallet">Digital Wallet</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateExpenseBtn">
                        <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                        Update Expense
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this expense? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                        Delete Expense
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Base URL for API
    const API_BASE_URL = '/api';
    
    // Global variables
    let expenses = [];
    let currentUser = null;
    let expenseToDelete = null;
    let categoryChart = null;
    let monthlyTrendChart = null;
    
    // Vibrant color palette for charts
    const vibrantColors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
        '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
        '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2',
        '#F9E79F', '#A9DFBF', '#E8DAEF', '#FAD7A0', '#AED6F1'
    ];
    
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setupEventListeners();
        checkAuthAndLoadData();
    });
    
    // Initialize the application
    function initializeApp() {
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDate').value = today;
        
        // Set default date range to current month
        const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('startDate').value = firstDay;
        document.getElementById('endDate').value = today;
        
        // Set report date defaults
        document.getElementById('reportStartDate').value = firstDay;
        document.getElementById('reportEndDate').value = today;
        
        // Set current month for category report
        const currentMonth = new Date().toISOString().slice(0, 7);
        document.getElementById('categoryReportMonth').value = currentMonth;
        
        // Set current date in hero section
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);
    }
    
    // Setup event listeners
    function setupEventListeners() {
        document.getElementById('expenseForm').addEventListener('submit', handleAddExpense);
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('refreshExpenses').addEventListener('click', loadDashboardData);
        document.getElementById('debugSession').addEventListener('click', debugSession);
        document.getElementById('updateExpenseBtn').addEventListener('click', updateExpense);
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteExpense);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        
        // Report generation event listeners
        document.getElementById('generateCurrentMonthReport').addEventListener('click', generateCurrentMonthReport);
        document.getElementById('generateCustomReport').addEventListener('click', generateCustomReport);
        document.getElementById('generateCategoryReport').addEventListener('click', generateCategoryReport);
        document.getElementById('refreshReportPreview').addEventListener('click', refreshReportPreview);
        
        // Navigation event listeners
        document.getElementById('reportsLink').addEventListener('click', showReportsSection);
        document.getElementById('dashboardLink').addEventListener('click', showDashboardSection);
        document.getElementById('footerReportsLink').addEventListener('click', showReportsSection);
        document.getElementById('footerDashboardLink').addEventListener('click', showDashboardSection);
    }
    
    // Show reports section
    function showReportsSection(e) {
        e.preventDefault();
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('reportsSection').style.display = 'block';
        
        // Update active nav link
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.getElementById('reportsLink').classList.add('active');
        
        // Load report preview
        refreshReportPreview();
    }
    
    // Show dashboard section
    function showDashboardSection(e) {
        e.preventDefault();
        document.getElementById('dashboardSection').style.display = 'block';
        document.getElementById('reportsSection').style.display = 'none';
        
        // Update active nav link
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.getElementById('dashboardLink').classList.add('active');
    }
    
    // Check if user is authenticated and load data
    async function checkAuthAndLoadData() {
        try {
            const response = await fetch('/auth/me', {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const user = await response.json();
                currentUser = user;
                document.getElementById('userFullName').textContent = user.fullName;
                
                // Extract first name for welcome message
                const firstName = user.fullName.split(' ')[0];
                document.getElementById('userFirstName').textContent = firstName;
                
                // Display profile photo
                displayProfilePhoto(user);
                
                loadDashboardData();
            } else {
                window.location.href = 'home.html';
            }
        } catch (error) {
            console.error('Error checking auth:', error);
            showAlert('Authentication error. Please login again.', 'danger');
            setTimeout(() => {
                window.location.href = 'home.html';
            }, 2000);
        }
    }
    
    // Function to display profile photo
    function displayProfilePhoto(user) {
        const profilePhoto = document.getElementById('profilePhoto');
        const defaultProfileIcon = document.getElementById('defaultProfileIcon');
        
        try {
            // Check if user has profile photo
            if (user.profilePhoto) {
                const base64String = convertToBase64(user.profilePhoto);
                if (base64String) {
                    profilePhoto.src = `data:image/jpeg;base64,${base64String}`;
                    profilePhoto.style.display = 'block';
                    defaultProfileIcon.style.display = 'none';
                    return;
                }
            }
            
            // Fallback to regular photo if profile photo doesn't exist or failed
            if (user.photo) {
                const base64String = convertToBase64(user.photo);
                if (base64String) {
                    profilePhoto.src = `data:image/jpeg;base64,${base64String}`;
                    profilePhoto.style.display = 'block';
                    defaultProfileIcon.style.display = 'none';
                    return;
                }
            }
            
            // Show default icon if no photos available or conversion failed
            profilePhoto.style.display = 'none';
            defaultProfileIcon.style.display = 'block';
            
        } catch (error) {
            console.error('Error displaying profile photo:', error);
            // Fallback to default icon
            profilePhoto.style.display = 'none';
            defaultProfileIcon.style.display = 'block';
        }
    }
    
    // Helper function to convert photo data to base64
    function convertToBase64(photoData) {
        if (photoData instanceof ArrayBuffer) {
            return arrayBufferToBase64(photoData);
        } else if (Array.isArray(photoData)) {
            // If it's a byte array
            const uint8Array = new Uint8Array(photoData);
            return arrayBufferToBase64(uint8Array);
        } else if (typeof photoData === 'string') {
            // If it's already a base64 string
            return photoData;
        } else {
            console.warn('Unknown profile photo format:', typeof photoData, photoData);
            return '';
        }
    }
    
    // Helper function to convert ArrayBuffer to base64
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }
    
    // Load all dashboard data
    async function loadDashboardData() {
        showLoadingState('expensesList', 'Loading dashboard data...');
        
        try {
            await loadStatsFromAPI();
            await loadExpenses();
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showAlert('Failed to load dashboard data', 'danger');
        }
    }
    
    // Load stats from API endpoint
    async function loadStatsFromAPI() {
        try {
            console.log("Loading stats from API...");
            
            const response = await fetch(`${API_BASE_URL}/expenses/dashboard-stats`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch dashboard stats');
            }
            
            const stats = await response.json();
            console.log("Stats from API:", stats);
            
            updateStatsBoxes(stats);
            
        } catch (error) {
            console.error('Error loading stats from API:', error);
            showAlert('Failed to load statistics', 'warning');
        }
    }
    
    // Update stats boxes with data from API
    function updateStatsBoxes(stats) {
        console.log("Updating stats boxes with:", stats);
        
        // Update Total This Month
        const totalThisMonth = stats.totalThisMonth || 0;
        document.getElementById('totalThisMonth').textContent = parseFloat(totalThisMonth).toFixed(2);
        
        // Update Daily Average
        const dailyAverage = stats.dailyAverage || 0;
        document.getElementById('dailyAverage').textContent = parseFloat(dailyAverage).toFixed(2);
        
        // Update Largest Expense
        const largestExpense = stats.largestExpense || 0;
        document.getElementById('largestExpense').textContent = parseFloat(largestExpense).toFixed(2);
        
        // Update Expense Count
        const expenseCount = stats.expenseCount || 0;
        document.getElementById('expenseCount').textContent = expenseCount;
    }
    
    // Load expenses from API
    async function loadExpenses() {
        showLoadingState('expensesList', 'Loading expenses...');
        
        try {
            expenses = await fetchExpenses();
            console.log('Loaded expenses:', expenses);
            renderExpenses(expenses);
            renderCharts(expenses);
        } catch (error) {
            console.error('Error loading expenses:', error);
            showAlert('Failed to load expenses', 'danger');
        }
    }
    
    // Fetch expenses from API
    async function fetchExpenses() {
        const response = await fetch(`${API_BASE_URL}/expenses`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch expenses');
        }
        
        return await response.json();
    }
    
    // Render expenses list
    function renderExpenses(expenses) {
        const expensesList = document.getElementById('expensesList');
        
        if (!expenses || expenses.length === 0) {
            expensesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-receipt"></i>
                    <h5>No expenses found</h5>
                    <p>Try adjusting your filters or add a new expense</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        expenses.forEach(expense => {
            const date = new Date(expense.expenseDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            html += `
                <div class="expense-item card m-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">${expense.description}</h6>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="text-muted me-3">
                                        <i class="far fa-calendar me-1"></i> ${date}
                                    </span>
                                    <span class="payment-method-badge">
                                        <i class="fas fa-wallet me-1"></i> ${expense.paymentMethod}
                                    </span>
                                </div>
                                <span class="category-badge" style="background-color: ${getCategoryColor(expense.category)};">
                                    ${expense.category}
                                </span>
                            </div>
                            <div class="text-end">
                                <div class="amount-positive mb-2 rupee-symbol">${parseFloat(expense.amount).toFixed(2)}</div>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-primary edit-expense" data-id="${expense.expenseId}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-expense" data-id="${expense.expenseId}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        expensesList.innerHTML = html;
        
        // Add event listeners to action buttons
        document.querySelectorAll('.edit-expense').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = parseInt(this.getAttribute('data-id'));
                openEditExpenseModal(expenseId);
            });
        });
        
        document.querySelectorAll('.delete-expense').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = parseInt(this.getAttribute('data-id'));
                openDeleteExpenseModal(expenseId);
            });
        });
    }
    
    // Handle adding a new expense
    async function handleAddExpense(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitExpenseBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
            
            const expenseDate = document.getElementById('expenseDate').value;
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            const newExpense = {
                expenseDate: expenseDate,
                description: description,
                amount: amount,
                category: category,
                paymentMethod: paymentMethod
            };
            
            await addExpense(newExpense);
            
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            await loadDashboardData();
            
            showAlert('Expense added successfully!', 'success');
            
        } catch (error) {
            console.error('Error adding expense:', error);
            showAlert('Failed to add expense: ' + error.message, 'danger');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
    
    // Add expense via API
    async function addExpense(expenseData) {
        const response = await fetch(`${API_BASE_URL}/expenses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(expenseData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to add expense');
        }
        
        return await response.json();
    }
    
    // Open edit expense modal
    async function openEditExpenseModal(expenseId) {
        try {
            const expense = await fetchExpenseById(expenseId);
            
            if (!expense) {
                showAlert('Expense not found', 'danger');
                return;
            }
            
            document.getElementById('editExpenseId').value = expense.expenseId;
            document.getElementById('editExpenseDate').value = expense.expenseDate;
            document.getElementById('editDescription').value = expense.description;
            document.getElementById('editAmount').value = expense.amount;
            document.getElementById('editCategory').value = expense.category;
            document.getElementById('editPaymentMethod').value = expense.paymentMethod;
            
            const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
            modal.show();
        } catch (error) {
            console.error('Error opening edit modal:', error);
            showAlert('Failed to load expense details', 'danger');
        }
    }
    
    // Fetch single expense by ID
    async function fetchExpenseById(expenseId) {
        const response = await fetch(`${API_BASE_URL}/expenses/${expenseId}`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch expense');
        }
        
        return await response.json();
    }
    
    // Update expense
    async function updateExpense() {
        const updateBtn = document.getElementById('updateExpenseBtn');
        const originalText = updateBtn.innerHTML;
        
        try {
            updateBtn.disabled = true;
            updateBtn.querySelector('.loading-spinner').style.display = 'inline-block';
            
            const expenseId = parseInt(document.getElementById('editExpenseId').value);
            const expenseDate = document.getElementById('editExpenseDate').value;
            const description = document.getElementById('editDescription').value;
            const amount = parseFloat(document.getElementById('editAmount').value);
            const category = document.getElementById('editCategory').value;
            const paymentMethod = document.getElementById('editPaymentMethod').value;
            
            const expenseData = {
                expenseDate: expenseDate,
                description: description,
                amount: amount,
                category: category,
                paymentMethod: paymentMethod
            };
            
            await updateExpenseAPI(expenseId, expenseData);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editExpenseModal'));
            modal.hide();
            
            await loadDashboardData();
            
            showAlert('Expense updated successfully!', 'success');
            
        } catch (error) {
            console.error('Error updating expense:', error);
            showAlert('Failed to update expense: ' + error.message, 'danger');
        } finally {
            updateBtn.disabled = false;
            updateBtn.querySelector('.loading-spinner').style.display = 'none';
        }
    }
    
    // Update expense via API
    async function updateExpenseAPI(expenseId, expenseData) {
        const response = await fetch(`${API_BASE_URL}/expenses/${expenseId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(expenseData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to update expense');
        }
        
        return await response.json();
    }
    
    // Open delete expense modal
    function openDeleteExpenseModal(expenseId) {
        expenseToDelete = expenseId;
        const modal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
        modal.show();
    }
    
    // Confirm delete expense
    async function confirmDeleteExpense() {
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        
        if (!expenseToDelete) return;
        
        try {
            deleteBtn.disabled = true;
            deleteBtn.querySelector('.loading-spinner').style.display = 'inline-block';
            
            await deleteExpenseAPI(expenseToDelete);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteExpenseModal'));
            modal.hide();
            
            await loadDashboardData();
            
            showAlert('Expense deleted successfully!', 'success');
            
        } catch (error) {
            console.error('Error deleting expense:', error);
            showAlert('Failed to delete expense: ' + error.message, 'danger');
        } finally {
            deleteBtn.disabled = false;
            deleteBtn.querySelector('.loading-spinner').style.display = 'none';
            expenseToDelete = null;
        }
    }
    
    // Delete expense via API
    async function deleteExpenseAPI(expenseId) {
        const response = await fetch(`${API_BASE_URL}/expenses/${expenseId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to delete expense');
        }
        
        return true;
    }
    
    // Apply filters
    async function applyFilters() {
        try {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const category = document.getElementById('filterCategory').value;
            
            if (startDate && endDate) {
                const filteredExpenses = await fetchExpensesByDateRange(startDate, endDate);
                let result = filteredExpenses;
                
                if (category) {
                    result = result.filter(expense => expense.category === category);
                }
                
                renderExpenses(result);
                renderCharts(result);
                showAlert('Filters applied!', 'info');
            } else {
                loadExpenses();
            }
        } catch (error) {
            console.error('Error applying filters:', error);
            showAlert('Failed to apply filters', 'danger');
        }
    }
    
    // Fetch expenses by date range
    async function fetchExpensesByDateRange(startDate, endDate) {
        const response = await fetch(`${API_BASE_URL}/expenses/date-range?startDate=${startDate}&endDate=${endDate}`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch expenses by date range');
        }
        
        return await response.json();
    }
    
    // Reset filters
    function resetFilters() {
        document.getElementById('startDate').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterPaymentMethod').value = '';
        
        loadDashboardData();
        showAlert('Filters reset!', 'info');
    }
    
    // Render charts with vibrant colors
    function renderCharts(expenses) {
        if (categoryChart) {
            categoryChart.destroy();
        }
        if (monthlyTrendChart) {
            monthlyTrendChart.destroy();
        }
        
        // Category chart with vibrant colors
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        
        const categories = {};
        expenses.forEach(expense => {
            if (categories[expense.category]) {
                categories[expense.category] += parseFloat(expense.amount);
            } else {
                categories[expense.category] = parseFloat(expense.amount);
            }
        });
        
        const categoryLabels = Object.keys(categories);
        const categoryData = Object.values(categories);
        
        // Generate vibrant colors for each category
        const categoryColors = categoryLabels.map((_, index) => 
            vibrantColors[index % vibrantColors.length]
        );
        
        if (categoryLabels.length > 0) {
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: categoryColors,
                        borderColor: categoryColors.map(color => color + 'CC'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
        }
        
        // Monthly trend chart with vibrant gradient
        const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
        const monthlyData = calculateMonthlyData(expenses);
        
        // Create gradient for line chart
        const gradient = monthlyCtx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(255, 107, 107, 0.6)');
        gradient.addColorStop(0.5, 'rgba(78, 205, 196, 0.4)');
        gradient.addColorStop(1, 'rgba(69, 183, 209, 0.2)');
        
        monthlyTrendChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Monthly Expenses',
                    data: monthlyData,
                    borderColor: '#FF6B6B',
                    backgroundColor: gradient,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#FF6B6B',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return 'â‚¹' + value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#4B3F36',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Calculate monthly data from expenses
    function calculateMonthlyData(expenses) {
        const monthlyTotals = new Array(12).fill(0);
        
        expenses.forEach(expense => {
            if (!expense.expenseDate) return;
            
            const expenseDate = new Date(expense.expenseDate);
            const month = expenseDate.getMonth();
            monthlyTotals[month] += parseFloat(expense.amount) || 0;
        });
        
        return monthlyTotals;
    }
    
    // Get category color - updated with vibrant colors
    function getCategoryColor(category) {
        const vibrantColorMap = {
            'Food & Dining': '#FF6B6B',
            'Shopping': '#4ECDC4',
            'Transportation': '#45B7D1',
            'Bills & Utilities': '#96CEB4',
            'Entertainment': '#FFEAA7',
            'Healthcare': '#DDA0DD',
            'Travel': '#98D8C8',
            'Education': '#F7DC6F',
            'Other': '#BB8FCE'
        };
        
        return vibrantColorMap[category] || '#85C1E9';
    }
    
    // Debug session
    async function debugSession() {
        try {
            const response = await fetch(`${API_BASE_URL}/expenses/session-debug`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const debugInfo = await response.json();
                console.log('Session Debug:', debugInfo);
                showAlert('Session debug info logged to console', 'info');
            }
        } catch (error) {
            console.error('Error debugging session:', error);
            showAlert('Failed to debug session', 'danger');
        }
    }
    
    // Show loading state
    function showLoadingState(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        element.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">${message}</p>
            </div>
        `;
    }
    
    // Show alert message
    function showAlert(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.alert-position').forEach(alert => alert.remove());
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show alert-position`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
    
    // Handle logout
    async function handleLogout(e) {
        e.preventDefault();
        
        try {
            const response = await fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.ok) {
                window.location.href = 'home.html';
            } else {
                throw new Error('Logout failed');
            }
        } catch (error) {
            console.error('Error during logout:', error);
            window.location.href = 'home.html';
        }
    }
    
    // =============== REPORT GENERATION FUNCTIONS ===============
    
    // Generate current month report
    async function generateCurrentMonthReport() {
        try {
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            
            const expenses = await fetchExpensesByDateRange(firstDay, today);
            generateExcelReport(expenses, `Expense_Report_${new Date().toISOString().slice(0, 7)}.xlsx`);
            
            showAlert('Current month report generated successfully!', 'success');
        } catch (error) {
            console.error('Error generating current month report:', error);
            showAlert('Failed to generate report: ' + error.message, 'danger');
        }
    }
    
    // Generate custom date range report
    async function generateCustomReport() {
        try {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates', 'warning');
                return;
            }
            
            const expenses = await fetchExpensesByDateRange(startDate, endDate);
            const fileName = `Expense_Report_${startDate}_to_${endDate}.xlsx`;
            generateExcelReport(expenses, fileName);
            
            showAlert('Custom date range report generated successfully!', 'success');
        } catch (error) {
            console.error('Error generating custom report:', error);
            showAlert('Failed to generate report: ' + error.message, 'danger');
        }
    }
    
    // Generate category summary report
    async function generateCategoryReport() {
        try {
            const month = document.getElementById('categoryReportMonth').value;
            
            if (!month) {
                showAlert('Please select a month', 'warning');
                return;
            }
            
            const startDate = `${month}-01`;
            const endDate = new Date(new Date(month).getFullYear(), new Date(month).getMonth() + 1, 0).toISOString().split('T')[0];
            
            const expenses = await fetchExpensesByDateRange(startDate, endDate);
            generateCategorySummaryReport(expenses, `Category_Summary_${month}.xlsx`);
            
            showAlert('Category summary report generated successfully!', 'success');
        } catch (error) {
            console.error('Error generating category report:', error);
            showAlert('Failed to generate report: ' + error.message, 'danger');
        }
    }
    
    // Generate Excel report from expenses
    function generateExcelReport(expenses, fileName) {
        if (!expenses || expenses.length === 0) {
            showAlert('No expenses found for the selected period', 'warning');
            return;
        }
        
        // Prepare data for Excel
        const data = [
            ['Date', 'Description', 'Amount (â‚¹)', 'Category', 'Payment Method']
        ];
        
        let totalAmount = 0;
        
        expenses.forEach(expense => {
            const date = new Date(expense.expenseDate).toLocaleDateString('en-US');
            data.push([
                date,
                expense.description,
                parseFloat(expense.amount).toFixed(2),
                expense.category,
                expense.paymentMethod
            ]);
            
            totalAmount += parseFloat(expense.amount);
        });
        
        // Add summary row
        data.push([]);
        data.push(['', 'TOTAL', totalAmount.toFixed(2), '', '']);
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Set column widths
        const wscols = [
            { wch: 12 }, // Date
            { wch: 30 }, // Description
            { wch: 15 }, // Amount
            { wch: 20 }, // Category
            { wch: 15 }  // Payment Method
        ];
        ws['!cols'] = wscols;
        
        // Create workbook and add worksheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
        
        // Generate and download the file
        XLSX.writeFile(wb, fileName);
    }
    
    // Generate category summary report
    function generateCategorySummaryReport(expenses, fileName) {
        if (!expenses || expenses.length === 0) {
            showAlert('No expenses found for the selected period', 'warning');
            return;
        }
        
        // Calculate category totals
        const categoryTotals = {};
        let overallTotal = 0;
        
        expenses.forEach(expense => {
            const amount = parseFloat(expense.amount);
            overallTotal += amount;
            
            if (categoryTotals[expense.category]) {
                categoryTotals[expense.category] += amount;
            } else {
                categoryTotals[expense.category] = amount;
            }
        });
        
        // Prepare data for Excel
        const data = [
            ['Category', 'Amount (â‚¹)', 'Percentage']
        ];
        
        // Add category rows
        Object.keys(categoryTotals).forEach(category => {
            const amount = categoryTotals[category];
            const percentage = ((amount / overallTotal) * 100).toFixed(2);
            data.push([category, amount.toFixed(2), `${percentage}%`]);
        });
        
        // Add summary row
        data.push([]);
        data.push(['TOTAL', overallTotal.toFixed(2), '100%']);
        
        // Create worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Set column widths
        const wscols = [
            { wch: 20 }, // Category
            { wch: 15 }, // Amount
            { wch: 15 }  // Percentage
        ];
        ws['!cols'] = wscols;
        
        // Create workbook and add worksheet
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Category Summary');
        
        // Generate and download the file
        XLSX.writeFile(wb, fileName);
    }
    
    // Refresh report preview
    async function refreshReportPreview() {
        try {
            const reportPreview = document.getElementById('reportPreview');
            showLoadingState('reportPreview', 'Loading report preview...');
            
            // Get current month expenses for preview
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            
            const expenses = await fetchExpensesByDateRange(firstDay, today);
            
            if (!expenses || expenses.length === 0) {
                reportPreview.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-excel"></i>
                        <h5>No expenses found for current month</h5>
                        <p>Add some expenses to see a preview here</p>
                    </div>
                `;
                return;
            }
            
            // Calculate category totals for preview
            const categoryTotals = {};
            let overallTotal = 0;
            
            expenses.forEach(expense => {
                const amount = parseFloat(expense.amount);
                overallTotal += amount;
                
                if (categoryTotals[expense.category]) {
                    categoryTotals[expense.category] += amount;
                } else {
                    categoryTotals[expense.category] = amount;
                }
            });
            
            // Generate preview HTML
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Month Summary</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>Total Expenses:</td>
                                    <td class="text-end"><strong>â‚¹${overallTotal.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td>Number of Expenses:</td>
                                    <td class="text-end"><strong>${expenses.length}</strong></td>
                                </tr>
                                <tr>
                                    <td>Average per Expense:</td>
                                    <td class="text-end"><strong>â‚¹${(overallTotal / expenses.length).toFixed(2)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Top Categories</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Sort categories by amount (descending)
            const sortedCategories = Object.keys(categoryTotals).sort((a, b) => categoryTotals[b] - categoryTotals[a]);
            
            // Show top 5 categories
            sortedCategories.slice(0, 5).forEach(category => {
                const amount = categoryTotals[category];
                const percentage = ((amount / overallTotal) * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${category}</td>
                        <td class="text-end">â‚¹${amount.toFixed(2)} (${percentage}%)</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted"><small>This preview shows data for the current month. Use the buttons above to generate full Excel reports.</small></p>
                </div>
            `;
            
            reportPreview.innerHTML = html;
            
        } catch (error) {
            console.error('Error refreshing report preview:', error);
            document.getElementById('reportPreview').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h5>Error loading preview</h5>
                    <p>Failed to load report preview data</p>
                </div>
            `;
        }
    }
</script>
</body>
</html>